#!/bin/bash

# This script runs the integration tests. It starts the test environment, runs the tests,
# and stops the containers. It saves the container logs to a file and edits /etc/hosts.
# Usage:
#   ./script.sh            # Run the script with default options
#   ./script.sh --no-build    # Skip building the docker images and internal test dependencies (-nb or --no-build)

log_file="./tmp/rafiki_integration_logs.txt"
build_flag="--build"

# Parse cli args
while [[ $# -gt 0 ]]; do
  case "$1" in
    -nb|--no-build)
      build_flag=""
      shift
      ;;
    *)
      echo "Unknown option: $1"
      exit 1
      ;;
  esac
done

if [ "$build_flag" == "--build" ]; then
  pnpm --filter integration build:deps
fi

# setup hosts
addHost() {
  local hostname="$1"

  # check first to avoid sudo prompt if host is already set
  if pnpm --filter integration hostile list | grep -q "127.0.0.1 $hostname"; then
    echo "$hostname already set"
  else
    echo "Ask: please provide sudo so we can add some hosts entries, view the file in bin/start to inspect why this is necessary"
    sudo pnpm --filter integration hostile set 127.0.0.1 "$hostname"
    if [ $? -ne 0 ]; then
      echo "Error: Failed to write hosts to hostfile."
      exit 1
    fi
  fi
}
addHost "cloud-nine-wallet-test-backend"
addHost "cloud-nine-wallet-test-auth"
addHost "happy-life-bank-backend"
addHost "happy-life-bank-auth"
addHost "happy-life-bank-test-backend"
addHost "happy-life-bank-test-auth"
addHost "stokvel-wallet-test-backend"
addHost "stokvel-wallet-test-auth"
addHost "stokvel-wallet-backend"
addHost "stokvel-wallet-auth"

# idempotent start
pnpm localenv:compose:stokvel down -v
pnpm localenv:compose:stokvel up
